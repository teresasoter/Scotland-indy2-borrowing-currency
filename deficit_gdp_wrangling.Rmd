---
title: "Data wrangling - Deficit as % of GDP"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library (tidyverse)
library (plotly)
library(zoo) # moving averages 
```
Note that positive values in deficit_pc mean budget surpluses and negative deficits
Uploading data 
```{r reading, message=FALSE}
df_deficit_pct <- read_csv("data/deficit_pct_gdp_OECD.csv")
```
Creating a wide-form dataset with columns for each year
There are 23 rows with flag E (estimate/preliminary data) and 1 B (break in series) that were put in table df_e_or_b
```{r}
df_deficit_pct %>% count(`Flag Codes`)
```

```{r}
df_deficit_pct %>% filter(!is.na(`Flag Codes`))
df_wide_deficit <- df_deficit_pct %>% 
  select(-`Flag Codes`) %>% #this removes the variable Flag Codes to make the wide dataset cleaner
  pivot_wider(names_from = TIME, values_from = deficit_pc)
```
Visualising balance as % of GDP for all countries over the years (positive values are surpluses, negative values are deficits)
```{r}
  p <- df_deficit_pct %>% #making p into a ggplot object to visualise w/ plotly
 # line below would invert surplus/deficit in deficit_pc, making higher values mean higher deficits
 # mutate(deficit_pc=-deficit_pc) %>% 
  ggplot(aes(TIME, deficit_pc, colour=LOCATION)) + 
  geom_line()
  ggplotly(p) #plotly lets me see the legend when scrolling through the plot
```
Creating rolling averages over 5, 7 and 10 years
```{r}
  df_deficit_pct <- df_deficit_pct %>% #this function uses longform
  group_by(LOCATION) %>% 
  mutate(bal_05ya = rollmean(deficit_pc, k = 5, fill = NA),
         bal_07ya = rollmean(deficit_pc, k = 7, fill = NA),
         bal_10ya = rollmean(deficit_pc, k = 10, fill = NA)) %>% 
        ungroup() #this closes that group_by(LOCATION)
```
Visualising 5 year rolling averages of balance as % of GDP for all countries 
```{r} 
    p <- df_deficit_pct %>%
    ggplot(aes(TIME, bal_05ya, colour=LOCATION)) + 
    geom_line()
    ggplotly(p) 
```
Visualising 7 year rolling averages of balance as % of GDP for all countries
```{r}
    p <- df_deficit_pct %>%
    ggplot(aes(TIME, bal_07ya, colour=LOCATION)) + 
    geom_line()
    ggplotly(p)
```
Visualising 10 year rolling averages of balance as % of GDP for all countries
```{r} 
    p <- df_deficit_pct %>%
    ggplot(aes(TIME, bal_10ya, colour=LOCATION)) + 
    geom_line()
    ggplotly(p) 
```


