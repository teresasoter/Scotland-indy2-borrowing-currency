---
title: "Data wrangling - Deficit as % of GDP"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library (tidyverse)
library (plotly)
library(zoo) # moving averages 
```

## Preparing data

Uploading data 
```{r reading, message=FALSE}
df_deficit_pct <- read_csv("data/deficit_pct_gdp_OECD.csv")
```
Creating a wide-form dataset with columns for each year
There are 23 rows with flag E (estimate/preliminary data) and 1 B (break in series) that were put in table df_e_or_b
```{r}
df_deficit_pct %>% count(`Flag Codes`)
```

```{r}
df_deficit_pct %>% filter(!is.na(`Flag Codes`))
df_wide_deficit <- df_deficit_pct %>% 
  select(-`Flag Codes`) %>% #this removes the variable Flag Codes to make the wide dataset cleaner
  pivot_wider(names_from = TIME, values_from = deficit_pc)
```
Creating a comparators variable
```{r} 
comparators <- c("DNK","IRL","NZL","NOR","SWE")
    df_deficit_pct <- df_deficit_pct %>%
    mutate(in_comparators=if_else(LOCATION%in%comparators,TRUE,FALSE)) 
```

Creating rolling averages over 5, 7 and 10 years
```{r}
  df_deficit_pct <- df_deficit_pct %>% #this function uses longform
  group_by(LOCATION) %>% 
  mutate(bal_05ya = rollmean(deficit_pc, k = 5, fill = NA),
         bal_07ya = rollmean(deficit_pc, k = 7, fill = NA),
         bal_10ya = rollmean(deficit_pc, k = 10, fill = NA)) %>% 
        ungroup() #this closes that group_by(LOCATION)
```

*deficit_pc and its rolling average recodings: Positive values mean budget surpluses and negative deficits*

## Exploring data

### Plot 1
Visualising balance as % of GDP for all countries over the years (positive values are surpluses, negative values are deficits)
```{r}
  p1 <- df_deficit_pct %>% #making p into a ggplot object to visualise w/ plotly
 # line below would invert surplus/deficit in deficit_pc, making higher values mean higher deficits
 # mutate(deficit_pc=-deficit_pc) %>% 
  ggplot(aes(TIME, deficit_pc, colour=LOCATION)) + 
  geom_line()
  ggplotly(p1) #plotly lets me see the legend when scrolling through the plot
```

### Plot 2
Visualising 5 year rolling averages of balance as % of GDP for all countries 
```{r} 
    p2 <- df_deficit_pct %>%
    ggplot(aes(TIME, bal_05ya, colour=LOCATION)) + 
    geom_line()
    ggplotly(p2)
```

### Plot 3
Visualising 7 year rolling averages of balance as % of GDP for all countries
```{r}
    p3 <- df_deficit_pct %>%
    ggplot(aes(TIME, bal_07ya, colour=LOCATION)) + 
    geom_line()
    ggplotly(p3)
```

### Plot 4
Visualising 10 year rolling averages of balance as % of GDP for all countries
```{r} 
    p4 <- df_deficit_pct %>%
    ggplot(aes(TIME, bal_10ya, colour=LOCATION)) + 
    geom_line()
    ggplotly(p4) 
```


###Plot 5
Visualising 7 year rolling averages of balance as % of GDP for all countries from 2000
```{r}
    p5 <- df_deficit_pct %>%
    filter(TIME>=2000) %>% 
    ggplot(aes(TIME, bal_07ya, colour=LOCATION)) + 
    geom_line()
    ggplotly(p5)
```


###Plot 6
Visualising 7 year rolling averages of deficit % of GDP for all countries(higher values mean higher deficit)
```{r}
    p6 <- df_deficit_pct %>%
    ggplot(aes(TIME, -bal_07ya, colour=LOCATION)) + 
    geom_line()
    ggplotly(p6)
```


###Plot 7
Visualising 7 year rolling averages of deficit % of GDP for all countries(higher values mean higher deficit) with highlighted comparators
```{r}
    p7 <- df_deficit_pct %>%
    ggplot(aes(TIME, -bal_07ya, colour=in_comparators, group=LOCATION)) + 
    geom_line()
    ggplotly(p7)
```


### Plot 8
Visualising deficit as % of GDP for all countries(higher values mean higher deficit) with highlighted comparators
```{r}
    p8 <- df_deficit_pct %>%
    ggplot(aes(TIME, -deficit_pc, colour=in_comparators, group=LOCATION)) + 
    geom_line()
    ggplotly(p8)
```